<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="z"><meta name="copyright" content="z"><meta name="generator" content="Hexo 5.4.0"><meta name="theme" content="hexo-theme-yun"><title>事务管理 | 日常</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/star-markdown-css@0.1.22/dist/yun/yun-markdown.min.css"><script src="//at.alicdn.com/t/font_1140697_ed8vp4atwoj.js" async></script><script src="https://cdn.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>document.addEventListener("DOMContentLoaded", () => {
  [".post-card",".post-content img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
});
</script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css"><script defer src="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/copy-tex.min.css"><script defer src="https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/copy-tex.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/auto-render.min.js"></script><script>document.addEventListener("DOMContentLoaded", function() {
  renderMathInElement(document.body, {
    delimiters: [
      {left: "$$", right: "$$", display: true},
      {left: "$", right: "$", display: false},
      {left: "\\(", right: "\\)", display: false},
      {left: "\\[", right: "\\]", display: true}
    ]
  });
});</script><link id="light-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.20.0/themes/prism.css" media="(prefers-color-scheme: light)"><link id="dark-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.20.0/themes/prism-tomorrow.css" media="(prefers-color-scheme: dark)"><link rel="shortcut icon" type="image/svg+xml" href="https://cdn.jsdelivr.net/gh/in-a-day/cdn@main/images/blog/favicon.ico"><link rel="mask-icon" href="https://cdn.jsdelivr.net/gh/in-a-day/cdn@main/images/blog/favicon.ico" color="#0078E7"><link rel="alternate icon" href="/yun.ico"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="preload" href="/js/utils.js" as="script"><link rel="preload" href="/js/hexo-theme-yun.js" as="script"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><script id="yun-config">
    const Yun = window.Yun || {};
    window.CONFIG = {"hostname":"nichijou.cloud","root":"/","title":"日常","version":"1.4.0","mode":"light","copycode":true,"page":{"isPost":true},"anonymous_image":"https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/avatar/none.jpg","say":{"api":"/data/sentences.json"},"local_search":{"path":"/search.xml"}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/utils.js"></script><script src="/js/hexo-theme-yun.js"></script><meta name="description" content="数据库事务相关介绍Spring事务相关之前, 先介绍一下数据库有关事务内容.数据库四大特性: ACID  Atomicity(原子性): 事务要么成功, 要么失败. Consistency(一致性): 系统从一个正确的状态迁移到另一个正确的状态. Isolation(隔离性): 允许多个事务并发执行, 事务不会被其他事务影响. Durability(持久性): 事务处理结束后对数据的修改是永久的,">
<meta property="og:type" content="article">
<meta property="og:title" content="事务管理">
<meta property="og:url" content="http://nichijou.cloud/2021/03/16/spring/transaction/index.html">
<meta property="og:site_name" content="日常">
<meta property="og:description" content="数据库事务相关介绍Spring事务相关之前, 先介绍一下数据库有关事务内容.数据库四大特性: ACID  Atomicity(原子性): 事务要么成功, 要么失败. Consistency(一致性): 系统从一个正确的状态迁移到另一个正确的状态. Isolation(隔离性): 允许多个事务并发执行, 事务不会被其他事务影响. Durability(持久性): 事务处理结束后对数据的修改是永久的,">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/in-a-day/cdn@main/images/java/spring/tx_prop_required.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/in-a-day/cdn@main/images/java/spring/tx_prop_requires_new.png">
<meta property="article:published_time" content="2021-03-16T09:14:59.000Z">
<meta property="article:modified_time" content="2021-06-03T09:28:35.718Z">
<meta property="article:author" content="z">
<meta property="article:tag" content="spring">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/in-a-day/cdn@main/images/java/spring/tx_prop_required.png"></head><body><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="文章目录"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-list-ordered"></use></svg></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="站点概览"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-passport-line"></use></svg></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="z"><img width="96" loading="lazy" src="https://cdn.jsdelivr.net/gh/in-a-day/cdn@main/images/blog/avatar.png" alt="z"></a><div class="site-author-name"><a href="/about/">z</a></div><a class="site-name" href="/about/site.html">日常</a><sub class="site-subtitle"></sub><div class="site-desciption"></div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="首页"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-home-4-line"></use></svg></span></a><div class="site-state-item"><a href="/archives/" title="归档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-archive-line"></use></svg></span><span class="site-state-item-count">62</span></a></div><div class="site-state-item"><a href="/categories/" title="分类"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-2-line"></use></svg></span><span class="site-state-item-count">11</span></a></div><div class="site-state-item"><a href="/tags/" title="标签"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="site-state-item-count">26</span></a></div><a class="site-state-item hty-icon-button" href="https://nichijou.cloud" title="文档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-settings-line"></use></svg></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/in-a-day" title="GitHub" target="_blank" style="color:#6e5494"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-github-line"></use></svg></a></div></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BA%8B%E5%8A%A1%E7%9B%B8%E5%85%B3"><span class="toc-number">1.</span> <span class="toc-text">数据库事务相关</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86%E6%8A%BD%E8%B1%A1"><span class="toc-number">2.</span> <span class="toc-text">Spring事务管理抽象</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring%E4%BA%8B%E5%8A%A1%E4%BC%A0%E6%92%AD%E5%B1%9E%E6%80%A7"><span class="toc-number">3.</span> <span class="toc-text">Spring事务传播属性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PROPAGATION-REQUIRED"><span class="toc-number">3.1.</span> <span class="toc-text">PROPAGATION_REQUIRED</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PROPAGATION-SUPPORTS"><span class="toc-number">3.2.</span> <span class="toc-text">PROPAGATION_SUPPORTS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PROPAGATION-MANDATORY"><span class="toc-number">3.3.</span> <span class="toc-text">PROPAGATION_MANDATORY</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PROPAGATION-REQUIRES-NEW"><span class="toc-number">3.4.</span> <span class="toc-text">PROPAGATION_REQUIRES_NEW</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PROPAGATION-NOT-SUPPORTED"><span class="toc-number">3.5.</span> <span class="toc-text">PROPAGATION_NOT_SUPPORTED</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PROPAGATION-NEVER"><span class="toc-number">3.6.</span> <span class="toc-text">PROPAGATION_NEVER</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PROPAGATION-NESTED"><span class="toc-number">3.7.</span> <span class="toc-text">PROPAGATION_NESTED</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB"><span class="toc-number">4.</span> <span class="toc-text">Spring隔离级别</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ISOLATION-DEFAULT"><span class="toc-number">4.1.</span> <span class="toc-text">ISOLATION_DEFAULT</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ISOLATION-READ-UNCOMMITTED"><span class="toc-number">4.2.</span> <span class="toc-text">ISOLATION_READ_UNCOMMITTED</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ISOLATION-READ-COMMITTED"><span class="toc-number">4.3.</span> <span class="toc-text">ISOLATION_READ_COMMITTED</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ISOLATION-REPEATABLE-READ"><span class="toc-number">4.4.</span> <span class="toc-text">ISOLATION_REPEATABLE_READ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ISOLATION-SERIALIZABLE"><span class="toc-number">4.5.</span> <span class="toc-text">ISOLATION_SERIALIZABLE</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Transactional%E6%B3%A8%E8%A7%A3"><span class="toc-number">5.</span> <span class="toc-text">@Transactional注解</span></a></li></ol></div></div></div><div class="tag-cloud"><div class="tag-cloud-tags"><a href="/tags/OAuth2/" style="font-size: 14px; color: #8895a2">OAuth2</a> <a href="/tags/dp/" style="font-size: 12px; color: #999">dp</a> <a href="/tags/gof/" style="font-size: 20px; color: #558abc">gof</a> <a href="/tags/java/" style="font-size: 30px; color: #0078e7">java</a> <a href="/tags/java-base/" style="font-size: 12px; color: #999">java-base</a> <a href="/tags/jvm/" style="font-size: 16px; color: #7792aa">jvm</a> <a href="/tags/jwt/" style="font-size: 12px; color: #999">jwt</a> <a href="/tags/leetcode/" style="font-size: 28px; color: #117cde">leetcode</a> <a href="/tags/mysql/" style="font-size: 12px; color: #999">mysql</a> <a href="/tags/nichijou/" style="font-size: 18px; color: #668eb3">nichijou</a> <a href="/tags/os/" style="font-size: 18px; color: #668eb3">os</a> <a href="/tags/redis/" style="font-size: 12px; color: #999">redis</a> <a href="/tags/spring/" style="font-size: 26px; color: #227fd6">spring</a> <a href="/tags/spring-security/" style="font-size: 22px; color: #4487c4">spring security</a> <a href="/tags/tree/" style="font-size: 12px; color: #999">tree</a> <a href="/tags/%E4%BA%8C%E5%88%86/" style="font-size: 12px; color: #999">二分</a> <a href="/tags/%E5%86%85%E5%AD%98%E8%99%9A%E6%8B%9F%E5%8C%96/" style="font-size: 12px; color: #999">内存虚拟化</a> <a href="/tags/%E5%88%9B%E5%BB%BA%E5%9E%8B/" style="font-size: 14px; color: #8895a2">创建型</a> <a href="/tags/%E5%8F%8C%E6%8C%87%E9%92%88/" style="font-size: 14px; color: #8895a2">双指针</a> <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 24px; color: #3383cd">多线程</a></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="post-block" itemscope itemtype="https://schema.org/Article"><link itemprop="mainEntityOfPage" href="http://nichijou.cloud/2021/03/16/spring/transaction/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="z"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="日常"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">事务管理<a class="post-edit-link" href="https://github.com/in-a-day/in-a-day.github.io/tree/hexo/source/_posts/spring/transaction.md" target="_blank" title="编辑" rel="noopener"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-edit-line"></use></svg></a></h1><div class="post-meta"><div class="post-time" style="display:inline-block"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-line"></use></svg></span> <time title="创建时间：2021-03-16 09:14:59" itemprop="dateCreated datePublished" datetime="2021-03-16T09:14:59+00:00">2021-03-16</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-2-line"></use></svg></span> <time title="修改时间：2021-06-03 09:28:35" itemprop="dateModified" datetime="2021-06-03T09:28:35+00:00">2021-06-03</time></div><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-line"></use></svg></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category" href="/categories/spring/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">spring</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag" href="/tags/spring/" style="--text-color:orange"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">spring</span></a></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body" style="--smc-primary:#0078E7;"><h2 id="数据库事务相关"><a href="#数据库事务相关" class="headerlink" title="数据库事务相关"></a><strong>数据库事务相关</strong></h2><p>介绍Spring事务相关之前, 先介绍一下数据库有关事务内容.<br>数据库四大特性: ACID</p>
<ul>
<li>Atomicity(原子性): 事务要么成功, 要么失败.</li>
<li>Consistency(一致性): 系统从一个正确的状态迁移到另一个正确的状态.</li>
<li>Isolation(隔离性): 允许多个事务并发执行, 事务不会被其他事务影响.</li>
<li>Durability(持久性): 事务处理结束后对数据的修改是永久的, 即使系统故障也不会丢失.</li>
</ul>
<p>其中Isolation又分为四个等级:</p>
<ul>
<li>read uncommited(未提交读)</li>
<li>read commited(提交读)</li>
<li>repeatable read(可重复读)</li>
<li>serilizable(串行化)</li>
</ul>
<p>由于不同的隔离策略, 并发时可能产生以下问题:</p>
<ul>
<li>脏读: 事务T1读取数据, 此时事务T2修改了T1读取的数据, 但未做提交, 而T1读取到了T2修改的数据, 这种情况就称为脏读.</li>
<li>不可重复读: 事务T1在一次事务中根据同一条件多次读取数据, 事务T2在T1读取间隔内修改了T1读取的数据, 导致T1多次读取的数据不一致, 称为不可重复读.</li>
<li>幻读: 事务T1在一次事务中根据同一条件多次读取数据, 事务T2在T1读取的间隔内增加或删除了T1读取的数据, 导致T1多次读取的数据变多/变少了, 称为幻读.</li>
</ul>
<p><strong>NB:</strong><br>不可重复读和幻读区别在于不可重复读是修改数据, 而幻读是增加/减少了数据.</p>
<h2 id="Spring事务管理抽象"><a href="#Spring事务管理抽象" class="headerlink" title="Spring事务管理抽象"></a><strong>Spring事务管理抽象</strong></h2><p>Spring 使用TransationManager进行事务管理抽象, 通常使用PlatformTransactionManager进行命令式的事务管理.<br>PlatformTransactionManager接口定义了一下方法:</p>
<ul>
<li>TransactionStatus getTransaction(TransactionDefinition definition: 获取事务状态.</li>
<li>void commit(TransactionStatus status): 提交事务</li>
<li>void rollback(TransactionStatus status): 回滚事务</li>
</ul>
<p>TransactionDefinition主要定义了以下内容:</p>
<ul>
<li>propagation: 事务传播属性</li>
<li>isolation: 事务隔离性级别</li>
<li>timeout: 事务运行时间, 超过改时间将由底层的事务管理器回滚事务.</li>
<li>read-only: 定义事务只读而不会修改数据.</li>
</ul>
<p>TransactionStatus用于控制事务和查询事务状态. TransactionStatus 继承了TransactionExecution, SavepointManager, Flushable接口.</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">TransactionStatus</span> <span class="token keyword">extends</span> <span class="token class-name">TransactionExecution</span><span class="token punctuation">,</span> <span class="token class-name">SavepointManager</span><span class="token punctuation">,</span> <span class="token class-name">Flushable</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// 是否存在保存点</span>
	<span class="token keyword">boolean</span> <span class="token function">hasSavepoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">void</span> <span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>TransactionExecution主要定义了一些表示当前事务状态的接口. </p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">TransactionExecution</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// 事务是否是新的事务</span>
	<span class="token keyword">boolean</span> <span class="token function">isNewTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 将事务属性设置为只能回滚</span>
	<span class="token keyword">void</span> <span class="token function">setRollbackOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 事务是否只能回滚</span>
	<span class="token keyword">boolean</span> <span class="token function">isRollbackOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 事务是否已经完成</span>
	<span class="token keyword">boolean</span> <span class="token function">isCompleted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>SavepointerManager定义了一些管理事务保存点的接口, 创建, 回滚事务保存点等.</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SavepointManager</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// 创建保存点</span>
	<span class="token class-name">Object</span> <span class="token function">createSavepoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TransactionException</span><span class="token punctuation">;</span>
	<span class="token comment">// 回滚到保存点</span>
	<span class="token keyword">void</span> <span class="token function">rollbackToSavepoint</span><span class="token punctuation">(</span><span class="token class-name">Object</span> savepoint<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TransactionException</span><span class="token punctuation">;</span>
	<span class="token comment">// 释放保存点</span>
	<span class="token keyword">void</span> <span class="token function">releaseSavepoint</span><span class="token punctuation">(</span><span class="token class-name">Object</span> savepoint<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TransactionException</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>下面具体介绍一下TransactionDefinition中定义的事务传播属性.</p>
<h2 id="Spring事务传播属性"><a href="#Spring事务传播属性" class="headerlink" title="Spring事务传播属性"></a><strong>Spring事务传播属性</strong></h2><p>TransactionDefinition中定义了如下传播属性:</p>
<ul>
<li>PROPAGATION_REQUIRED</li>
<li>PROPAGATION_SUPPORTS</li>
<li>PROPAGATION_MANDATORY</li>
<li>PROPAGATION_REQUIRES_NEW</li>
<li>PROPAGATION_NOT_SUPPORTED</li>
<li>PROPAGATION_NEVER</li>
<li>PROPAGATION_NESTED</li>
</ul>
<p>Spring提供了<code>Propagation</code>枚举类来映射到<code>TransactionDefinition</code>的传播属性:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">Propagation</span> <span class="token punctuation">&#123;</span>

	<span class="token function">REQUIRED</span><span class="token punctuation">(</span><span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span>PROPAGATION_REQUIRED<span class="token punctuation">)</span><span class="token punctuation">,</span>

	<span class="token function">SUPPORTS</span><span class="token punctuation">(</span><span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span>PROPAGATION_SUPPORTS<span class="token punctuation">)</span><span class="token punctuation">,</span>

	<span class="token function">MANDATORY</span><span class="token punctuation">(</span><span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span>PROPAGATION_MANDATORY<span class="token punctuation">)</span><span class="token punctuation">,</span>

	<span class="token function">REQUIRES_NEW</span><span class="token punctuation">(</span><span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span>PROPAGATION_REQUIRES_NEW<span class="token punctuation">)</span><span class="token punctuation">,</span>

	<span class="token function">NOT_SUPPORTED</span><span class="token punctuation">(</span><span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span>PROPAGATION_NOT_SUPPORTED<span class="token punctuation">)</span><span class="token punctuation">,</span>

	<span class="token function">NEVER</span><span class="token punctuation">(</span><span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span>PROPAGATION_NEVER<span class="token punctuation">)</span><span class="token punctuation">,</span>

	<span class="token function">NESTED</span><span class="token punctuation">(</span><span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span>PROPAGATION_NESTED<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> value<span class="token punctuation">;</span>

	<span class="token class-name">Propagation</span><span class="token punctuation">(</span><span class="token keyword">int</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="PROPAGATION-REQUIRED"><a href="#PROPAGATION-REQUIRED" class="headerlink" title="PROPAGATION_REQUIRED"></a><strong>PROPAGATION_REQUIRED</strong></h3><blockquote>
<p>Spring默认的事务传播行为. 支持当前事务, 如果不存在事务就创建一个新的事务.</p>
</blockquote>
<p><strong>NB: Spring通过Aop进行事务控制, 所以只要理解Aop的触发时机就可以容易理解事务的传播机制.</strong></p>
<p>下面看一下具体的例子: </p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">&#123;</span>
	<span class="token annotation punctuation">@Transaction</span><span class="token punctuation">(</span>propagation<span class="token operator">=</span><span class="token class-name">Propagation</span><span class="token punctuation">.</span>REQUIRED<span class="token punctuation">)</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// NB: 这里调用的并不是代理类中的doFunc()方法, 而是被代理的普通方法.</span>
		<span class="token function">doFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">B</span><span class="token punctuation">.</span><span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// 处理...</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">class</span> <span class="token class-name">B</span> <span class="token punctuation">&#123;</span>
	<span class="token annotation punctuation">@Transaction</span><span class="token punctuation">(</span>propagation<span class="token operator">=</span><span class="token class-name">Propagation</span><span class="token punctuation">.</span>REQUIRED<span class="token punctuation">)</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果调用A接口的func函数, 由于不存在事务, A会新建一个事务, A中调用B中的事务时, B将会使用A中的事务. 如果B中的事务发生异常, 那么A, B全部回滚. A中事务发生异常, A, B全部回滚.  </p>
<p>看一下B发生异常的情况(默认A不发生异常):</p>
<ul>
<li>B发生异常但是不抛出异常, Sprig Aop无法捕获异常, 正常执行, 事务不会回滚.</li>
<li>B发生异常并抛出, 且A也抛出异常, A, B都会回滚.</li>
<li>B发生异常且B抛出该异常, A进行捕获, 并且A不抛出异常, A, B都会回滚. 原理: B中发生异常, Spring的Aop捕获到该异常, 并将事务的状态设置为rollback-only(只能回滚), 由于A, B是同一个事务, 但是A中捕获了该异常, 并未抛出, A在提交事务时, 发现只能回滚事务, 所以抛出了<code>org.springframework.transaction.UnexpectedRollbackException: Transaction rolled back because it has been marked as rollback-only</code>异常, 并且回滚了事务.</li>
</ul>
<p>看一下A发生异常的情况(默认B不发生异常):</p>
<ul>
<li>A发生异常并抛出, A, B都会回滚</li>
<li>A发生异常但是不抛出, 正常提交事务.</li>
</ul>
<p>假设A方法存在事务, A方法中调用B方法, 则B方法也使用A方法的事务.<br>Spring官方的解释:<br><img src="https://cdn.jsdelivr.net/gh/in-a-day/cdn@main/images/java/spring/tx_prop_required.png" alt="prop-required" loading="lazy">_PROPAGATION_REQUIRED_</p>
<h3 id="PROPAGATION-SUPPORTS"><a href="#PROPAGATION-SUPPORTS" class="headerlink" title="PROPAGATION_SUPPORTS"></a><strong>PROPAGATION_SUPPORTS</strong></h3><blockquote>
<p>支持当前事务, 如果当前域存在事务, 就以当前事务执行, 如果不存在事务, 就以非事务方式执行.</p>
</blockquote>
<h3 id="PROPAGATION-MANDATORY"><a href="#PROPAGATION-MANDATORY" class="headerlink" title="PROPAGATION_MANDATORY"></a><strong>PROPAGATION_MANDATORY</strong></h3><blockquote>
<p>支持当前事务, 如果不存在事务, 抛出异常</p>
</blockquote>
<h3 id="PROPAGATION-REQUIRES-NEW"><a href="#PROPAGATION-REQUIRES-NEW" class="headerlink" title="PROPAGATION_REQUIRES_NEW"></a><strong>PROPAGATION_REQUIRES_NEW</strong></h3><blockquote>
<p>不管是否存在事务, 都会新建一个事务.</p>
</blockquote>
<p>Spring官方解释:<br><img src="https://cdn.jsdelivr.net/gh/in-a-day/cdn@main/images/java/spring/tx_prop_requires_new.png" alt="prop-required" loading="lazy"><em>PROPAGATION_REQUIRES_NEW</em></p>
<h3 id="PROPAGATION-NOT-SUPPORTED"><a href="#PROPAGATION-NOT-SUPPORTED" class="headerlink" title="PROPAGATION_NOT_SUPPORTED"></a><strong>PROPAGATION_NOT_SUPPORTED</strong></h3><blockquote>
<p>不支持事务, 不管是否存在事务, 都会以非事务方式执行.</p>
</blockquote>
<h3 id="PROPAGATION-NEVER"><a href="#PROPAGATION-NEVER" class="headerlink" title="PROPAGATION_NEVER"></a><strong>PROPAGATION_NEVER</strong></h3><blockquote>
<p>不支持事务, 如果存在事务, 抛出异常. 不存在事务以非事务方式运行.</p>
</blockquote>
<h3 id="PROPAGATION-NESTED"><a href="#PROPAGATION-NESTED" class="headerlink" title="PROPAGATION_NESTED"></a><strong>PROPAGATION_NESTED</strong></h3><blockquote>
<p>如果存在事务, 使用内嵌事务, 如果不存在事务, 则新建一个事务.<br>使用内嵌事务: 内嵌事务如果抛出异常, 内嵌事务回滚, 而父事务不会回滚父事务如果抛出异常, 则父事务和内嵌事务都需要回滚.</p>
</blockquote>
<h2 id="Spring隔离级别"><a href="#Spring隔离级别" class="headerlink" title="Spring隔离级别"></a>Spring隔离级别</h2><p><code>TransactionDefinition</code>定义了以下几个隔离级别:</p>
<ul>
<li>ISOLATION_DEFAULT</li>
<li>ISOLATION_READ_UNCOMMITTED</li>
<li>ISOLATION_READ_COMMITTED</li>
<li>ISOLATION_REPEATABLE_READ</li>
<li>ISOLATION_SERIALIZABLE</li>
</ul>
<p>Spring同时定义了<code>Isolation</code>枚举类对应以上级别:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">Isolation</span> <span class="token punctuation">&#123;</span>
	<span class="token function">DEFAULT</span><span class="token punctuation">(</span><span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span>ISOLATION_DEFAULT<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token function">READ_UNCOMMITTED</span><span class="token punctuation">(</span><span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span>ISOLATION_READ_UNCOMMITTED<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token function">READ_COMMITTED</span><span class="token punctuation">(</span><span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span>ISOLATION_READ_COMMITTED<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token function">REPEATABLE_READ</span><span class="token punctuation">(</span><span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span>ISOLATION_REPEATABLE_READ<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token function">SERIALIZABLE</span><span class="token punctuation">(</span><span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span>ISOLATION_SERIALIZABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> value<span class="token punctuation">;</span>

	<span class="token class-name">Isolation</span><span class="token punctuation">(</span><span class="token keyword">int</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="ISOLATION-DEFAULT"><a href="#ISOLATION-DEFAULT" class="headerlink" title="ISOLATION_DEFAULT"></a>ISOLATION_DEFAULT</h3><blockquote>
<p>使用数据库默认级别</p>
</blockquote>
<p>Oracle: Read committed<br>Mysql: Repeatable read</p>
<p>Oracle数据库只支持Read committed和Serializable两种隔离等级, 所以Oracle不存在脏读的现象, 但是默认的Read committed 也无法解决不可重复读和幻读的问题.</p>
<h3 id="ISOLATION-READ-UNCOMMITTED"><a href="#ISOLATION-READ-UNCOMMITTED" class="headerlink" title="ISOLATION_READ_UNCOMMITTED"></a>ISOLATION_READ_UNCOMMITTED</h3><blockquote>
<p>读未提交, 可能会导致脏读</p>
</blockquote>
<h3 id="ISOLATION-READ-COMMITTED"><a href="#ISOLATION-READ-COMMITTED" class="headerlink" title="ISOLATION_READ_COMMITTED"></a>ISOLATION_READ_COMMITTED</h3><blockquote>
<p>读已提交, 不会导致脏读, 但是会存在不可重复读, 和幻读问题</p>
</blockquote>
<h3 id="ISOLATION-REPEATABLE-READ"><a href="#ISOLATION-REPEATABLE-READ" class="headerlink" title="ISOLATION_REPEATABLE_READ"></a>ISOLATION_REPEATABLE_READ</h3><blockquote>
<p>重复读, 解决脏读, 不可重复读, 但还是存在幻读问题</p>
</blockquote>
<h3 id="ISOLATION-SERIALIZABLE"><a href="#ISOLATION-SERIALIZABLE" class="headerlink" title="ISOLATION_SERIALIZABLE"></a>ISOLATION_SERIALIZABLE</h3><blockquote>
<p>串行化, 脏读, 不可重复读, 幻读都可以解决, 通常情况下不会使用该隔离级别</p>
</blockquote>
<h2 id="Transactional注解"><a href="#Transactional注解" class="headerlink" title="@Transactional注解"></a>@Transactional注解</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span>TYPE<span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span>METHOD<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Inherited</span>
<span class="token annotation punctuation">@Documented</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">Transactional</span> <span class="token punctuation">&#123;</span>

	<span class="token annotation punctuation">@AliasFor</span><span class="token punctuation">(</span><span class="token string">"transactionManager"</span><span class="token punctuation">)</span>
	<span class="token class-name">String</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">""</span><span class="token punctuation">;</span>

    <span class="token comment">// 指定事务管理器</span>
	<span class="token annotation punctuation">@AliasFor</span><span class="token punctuation">(</span><span class="token string">"value"</span><span class="token punctuation">)</span>
	<span class="token class-name">String</span> <span class="token function">transactionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">""</span><span class="token punctuation">;</span>

    <span class="token comment">// 定义事务标签, 用于描述事务</span>
	<span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">label</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token comment">// 事务传播属性, 默认REQUIRED</span>
	<span class="token class-name">Propagation</span> <span class="token function">propagation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token class-name">Propagation</span><span class="token punctuation">.</span>REQUIRED<span class="token punctuation">;</span>

    <span class="token comment">// 事务的隔离级别, 默认DEFAULT</span>
	<span class="token class-name">Isolation</span> <span class="token function">isolation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token class-name">Isolation</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">;</span>

    <span class="token comment">// 事务超时时间(秒)</span>
	<span class="token keyword">int</span> <span class="token function">timeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span>TIMEOUT_DEFAULT<span class="token punctuation">;</span>

	<span class="token class-name">String</span> <span class="token function">timeoutString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">""</span><span class="token punctuation">;</span>

    <span class="token comment">// 如果事务是只读的可以将该标志设置为true, 从而获得运行时优化</span>
    <span class="token comment">// 并不保证只读事务在进行写事务时会抛出异常.</span>
	<span class="token keyword">boolean</span> <span class="token function">readOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token comment">// 定义异常回滚, 表示发生该异常进行回滚</span>
    <span class="token comment">// 默认情况下发生RuntimeException和Error时会进行回滚, 但是受检的异常不会回滚</span>
	<span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Throwable</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">rollbackFor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token comment">// 异常回滚全限定类名</span>
	<span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">rollbackForClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token comment">// 设置不回滚的异常, 如果异常同时存在于rollbackFor()中, 将会回滚异常.</span>
	<span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Throwable</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">noRollbackFor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token comment">// 异常不会滚全限定类名</span>
	<span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">noRollbackForClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



</div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>z</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="http://nichijou.cloud/2021/03/16/spring/transaction/" title="事务管理">http://nichijou.cloud/2021/03/16/spring/transaction/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><svg class="icon"><use xlink:href="#icon-creative-commons-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-by-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-nc-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-sa-line"></use></svg></a> 许可协议。</li></ul></section></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/2021/03/17/java/proxy/" rel="prev" title="代理模式"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-left-s-line"></use></svg><span class="post-nav-text">代理模式</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/2021/03/15/java/base/hashmap/" rel="next" title="HashMap详解"><span class="post-nav-text">HashMap详解</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-right-s-line"></use></svg></a></div></div></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2021 </span><span class="with-love" id="animate"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></span><span class="author"> z</span></div><div class="powered"><span>由 <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> 驱动 v5.4.0</span><span class="footer-separator">|</span><span>主题 - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.4.0</span></div></footer><a class="hty-icon-button" id="goUp" aria-label="back-to-top" href="#"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-up-s-line"></use></svg><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a><a class="popup-trigger hty-icon-button icon-search" id="search" href="javascript:;" title="搜索"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search-line"></use></svg></span></a><script>window.addEventListener("DOMContentLoaded", () => {
  // Handle and trigger popup window
  document.querySelector(".popup-trigger").addEventListener("click", () => {
    document.querySelector(".popup").classList.add("show");
    setTimeout(() => {
      document.querySelector(".search-input").focus();
    }, 100);
  });

  // Monitor main search box
  const onPopupClose = () => {
    document.querySelector(".popup").classList.remove("show");
  };

  document.querySelector(".popup-btn-close").addEventListener("click", () => {
    onPopupClose();
  });

  window.addEventListener("keyup", event => {
    if (event.key === "Escape") {
      onPopupClose();
    }
  });
});
</script><script src="/js/search/local-search.js" defer></script><div class="popup search-popup"><div class="search-header"><span class="popup-btn-close close-icon hty-icon-button"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-close-line"></use></svg></span></div><div class="search-input-container"><input class="search-input" id="local-search-input" type="text" placeholder="搜索..." value=""></div><div id="local-search-result"></div></div></div></body></html>
<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="z"><meta name="copyright" content="z"><meta name="generator" content="Hexo 5.4.0"><meta name="theme" content="hexo-theme-yun"><title>Spring Security Filter使用(5.4.5) | 日常</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/star-markdown-css@0.1.22/dist/yun/yun-markdown.min.css"><script src="//at.alicdn.com/t/font_1140697_ed8vp4atwoj.js" async></script><script src="https://cdn.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>document.addEventListener("DOMContentLoaded", () => {
  [".post-card",".post-content img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
});
</script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css"><script defer src="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/copy-tex.min.css"><script defer src="https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/copy-tex.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/auto-render.min.js"></script><script>document.addEventListener("DOMContentLoaded", function() {
  renderMathInElement(document.body, {
    delimiters: [
      {left: "$$", right: "$$", display: true},
      {left: "$", right: "$", display: false},
      {left: "\\(", right: "\\)", display: false},
      {left: "\\[", right: "\\]", display: true}
    ]
  });
});</script><link id="light-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.20.0/themes/prism.css" media="(prefers-color-scheme: light)"><link id="dark-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.20.0/themes/prism-tomorrow.css" media="(prefers-color-scheme: dark)"><link rel="shortcut icon" type="image/svg+xml" href="https://cdn.jsdelivr.net/gh/in-a-day/cdn@main/images/blog/favicon.ico"><link rel="mask-icon" href="https://cdn.jsdelivr.net/gh/in-a-day/cdn@main/images/blog/favicon.ico" color="#0078E7"><link rel="alternate icon" href="/yun.ico"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="preload" href="/js/utils.js" as="script"><link rel="preload" href="/js/hexo-theme-yun.js" as="script"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><script id="yun-config">
    const Yun = window.Yun || {};
    window.CONFIG = {"hostname":"nichijou.cloud","root":"/","title":"日常","version":"1.4.0","mode":"light","copycode":true,"page":{"isPost":true},"anonymous_image":"https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/avatar/none.jpg","say":{"api":"/data/sentences.json"},"local_search":{"path":"/search.xml"}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/utils.js"></script><script src="/js/hexo-theme-yun.js"></script><meta name="description" content="Spring Security通过使用标准的ServletFilter整合了Servlet容器. 这也就意味着它可以运行在任意的Servlet容器中. 更具体的来说, 不必在基于Servlet的应用中使用Spring就可以使用Spring Security.  以下将介绍这些内容:  Filter, Servlet中的Filter及FilterChain DelegatingFilterChai">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring Security Filter使用(5.4.5)">
<meta property="og:url" content="http://nichijou.cloud/2021/03/24/spring/spring-security/spring_security_with_servlet/index.html">
<meta property="og:site_name" content="日常">
<meta property="og:description" content="Spring Security通过使用标准的ServletFilter整合了Servlet容器. 这也就意味着它可以运行在任意的Servlet容器中. 更具体的来说, 不必在基于Servlet的应用中使用Spring就可以使用Spring Security.  以下将介绍这些内容:  Filter, Servlet中的Filter及FilterChain DelegatingFilterChai">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/in-a-day/cdn@main/images/java/spring/spring-security/filterchain.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/in-a-day/cdn@main/images/java/spring/spring-security/delegatingfilterproxy.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/in-a-day/cdn@main/images/java/spring/spring-security/filterchainproxy.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/in-a-day/cdn@main/images/java/spring/spring-security/securityfilterchain.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/in-a-day/cdn@main/images/java/spring/spring-security/multi-securityfilterchain.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/in-a-day/cdn@main/images/java/spring/spring-security/exceptiontranslationfilter.png">
<meta property="article:published_time" content="2021-03-24T15:10:00.000Z">
<meta property="article:modified_time" content="2021-06-03T09:28:35.718Z">
<meta property="article:author" content="z">
<meta property="article:tag" content="java">
<meta property="article:tag" content="spring">
<meta property="article:tag" content="spring security">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/in-a-day/cdn@main/images/java/spring/spring-security/filterchain.png"></head><body><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="文章目录"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-list-ordered"></use></svg></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="站点概览"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-passport-line"></use></svg></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="z"><img width="96" loading="lazy" src="https://cdn.jsdelivr.net/gh/in-a-day/cdn@main/images/blog/avatar.png" alt="z"></a><div class="site-author-name"><a href="/about/">z</a></div><a class="site-name" href="/about/site.html">日常</a><sub class="site-subtitle"></sub><div class="site-desciption"></div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="首页"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-home-4-line"></use></svg></span></a><div class="site-state-item"><a href="/archives/" title="归档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-archive-line"></use></svg></span><span class="site-state-item-count">62</span></a></div><div class="site-state-item"><a href="/categories/" title="分类"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-2-line"></use></svg></span><span class="site-state-item-count">11</span></a></div><div class="site-state-item"><a href="/tags/" title="标签"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="site-state-item-count">26</span></a></div><a class="site-state-item hty-icon-button" href="https://nichijou.cloud" title="文档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-settings-line"></use></svg></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/in-a-day" title="GitHub" target="_blank" style="color:#6e5494"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-github-line"></use></svg></a></div></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Filter%E6%A6%82%E8%A7%88"><span class="toc-number">1.</span> <span class="toc-text">Filter概览</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DelegatingFilterProxy"><span class="toc-number"></span> <span class="toc-text">DelegatingFilterProxy</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FilterChainProxy"><span class="toc-number"></span> <span class="toc-text">FilterChainProxy</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SecurityFilterChain"><span class="toc-number"></span> <span class="toc-text">SecurityFilterChain</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Security-Filters"><span class="toc-number"></span> <span class="toc-text">Security Filters</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%84%E7%90%86Security%E5%BC%82%E5%B8%B8"><span class="toc-number"></span> <span class="toc-text">处理Security异常</span></a></div></div></div><div class="tag-cloud"><div class="tag-cloud-tags"><a href="/tags/OAuth2/" style="font-size: 14px; color: #8895a2">OAuth2</a> <a href="/tags/dp/" style="font-size: 12px; color: #999">dp</a> <a href="/tags/gof/" style="font-size: 20px; color: #558abc">gof</a> <a href="/tags/java/" style="font-size: 30px; color: #0078e7">java</a> <a href="/tags/java-base/" style="font-size: 12px; color: #999">java-base</a> <a href="/tags/jvm/" style="font-size: 16px; color: #7792aa">jvm</a> <a href="/tags/jwt/" style="font-size: 12px; color: #999">jwt</a> <a href="/tags/leetcode/" style="font-size: 28px; color: #117cde">leetcode</a> <a href="/tags/mysql/" style="font-size: 12px; color: #999">mysql</a> <a href="/tags/nichijou/" style="font-size: 18px; color: #668eb3">nichijou</a> <a href="/tags/os/" style="font-size: 18px; color: #668eb3">os</a> <a href="/tags/redis/" style="font-size: 12px; color: #999">redis</a> <a href="/tags/spring/" style="font-size: 26px; color: #227fd6">spring</a> <a href="/tags/spring-security/" style="font-size: 22px; color: #4487c4">spring security</a> <a href="/tags/tree/" style="font-size: 12px; color: #999">tree</a> <a href="/tags/%E4%BA%8C%E5%88%86/" style="font-size: 12px; color: #999">二分</a> <a href="/tags/%E5%86%85%E5%AD%98%E8%99%9A%E6%8B%9F%E5%8C%96/" style="font-size: 12px; color: #999">内存虚拟化</a> <a href="/tags/%E5%88%9B%E5%BB%BA%E5%9E%8B/" style="font-size: 14px; color: #8895a2">创建型</a> <a href="/tags/%E5%8F%8C%E6%8C%87%E9%92%88/" style="font-size: 14px; color: #8895a2">双指针</a> <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 24px; color: #3383cd">多线程</a></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="post-block" itemscope itemtype="https://schema.org/Article"><link itemprop="mainEntityOfPage" href="http://nichijou.cloud/2021/03/24/spring/spring-security/spring_security_with_servlet/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="z"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="日常"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Spring Security Filter使用(5.4.5)<a class="post-edit-link" href="https://github.com/in-a-day/in-a-day.github.io/tree/hexo/source/_posts/spring/spring-security/spring_security_with_servlet.md" target="_blank" title="编辑" rel="noopener"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-edit-line"></use></svg></a></h1><div class="post-meta"><div class="post-time" style="display:inline-block"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-line"></use></svg></span> <time title="创建时间：2021-03-24 15:10:00" itemprop="dateCreated datePublished" datetime="2021-03-24T15:10:00+00:00">2021-03-24</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-2-line"></use></svg></span> <time title="修改时间：2021-06-03 09:28:35" itemprop="dateModified" datetime="2021-06-03T09:28:35+00:00">2021-06-03</time></div><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-line"></use></svg></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category" href="/categories/spring/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">spring</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag" href="/tags/java/" style="--text-color:crimson"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">java</span></a><a class="tag" href="/tags/spring/" style="--text-color:orange"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">spring</span></a><a class="tag" href="/tags/spring-security/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">spring security</span></a></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body" style="--smc-primary:#0078E7;"><blockquote>
<p>Spring Security通过使用标准的Servlet<code>Filter</code>整合了Servlet容器. 这也就意味着它可以运行在任意的Servlet容器中. 更具体的来说, 不必在基于Servlet的应用中使用Spring就可以使用Spring Security.</p>
</blockquote>
<p>以下将介绍这些内容:</p>
<ul>
<li>Filter, Servlet中的Filter及FilterChain</li>
<li>DelegatingFilterChainProxy</li>
<li>FilterChainProxy</li>
<li>SecurityFilterChain</li>
<li>Security Filters</li>
</ul>
<h3 id="Filter概览"><a href="#Filter概览" class="headerlink" title="Filter概览"></a>Filter概览</h3><p>Spring Security基于Servlet的<code>Filter</code>, 下面看一下一个典型的单个HTTP请求的处理层级.<br><img src="https://cdn.jsdelivr.net/gh/in-a-day/cdn@main/images/java/spring/spring-security/filterchain.png" alt="FilterChain" loading="lazy"><em>FilterChain</em><br>客户端发送一个请求到应用, 容器创建一个<code>FilterChain</code>, 其中包含了<code>Filter</code>和<code>Servlet</code>用于处理基于请求URL路径的<code>HttpServletRequest</code>. 在Spring MVC中该Servlet是<code>DispatchServlet</code>的一个实例. 最多使用一个<code>Servlet</code>处理一个<code>HttpServletRequest</code>和<code>HttpServletResponse</code>. 然而可以有多个<code>Filter</code>用于以下:</p>
<ul>
<li>阻止下游(downstream) <code>Filter</code>或<code>Servlet</code>被调用. </li>
<li>使用下游<code>Filter</code>和<code>Servlet</code>修改<code>HttpServletRequest</code>或<code>HttpServletResponse</code>.</li>
</ul>
<p>FilterChain示例:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// do something before the rest of the application</span>
    chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// invoke the rest of the application</span>
    <span class="token comment">// do something after the rest of the application</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>因为<code>Filter</code>会影响下游的<code>Filter</code>和<code>Servlet</code>, 所以Filter的执行顺序极其重要.</p>
<h2 id="DelegatingFilterProxy"><a href="#DelegatingFilterProxy" class="headerlink" title="DelegatingFilterProxy"></a><strong>DelegatingFilterProxy</strong></h2><p>Spring提供了一个<code>Filter</code>的实现<code>DelegatingFilterProxy</code>, 该实现连接了Servlet容器生命周期和Spring的<code>ApplicationContext</code>. Servlet容器允许使用其标准注册<code>Filter</code>, 但是无法知晓Spring定义的Bean(即Spring管理的Bean实现了Filter接口, 但是未使用Servlet标准进行注册). <code>DelegatingFilterProxy</code>可以通过标准的Servlet容器技术注册<code>Filter</code>, 同时将任务委派给实现了<code>Filter</code>接口的Spring Bean.</p>
<p>下图展示了<code>DelegatingFilterProxy</code>如何适配<code>Filter</code>和<code>FilterChain</code>:<br><img src="https://cdn.jsdelivr.net/gh/in-a-day/cdn@main/images/java/spring/spring-security/delegatingfilterproxy.png" alt="DelegatingFilterProxy" loading="lazy"><em>DelegatingFilterProxy</em><br><code>DelegatingFilterProxy</code>从<code>Application</code>中查找Bean Filter<sub>0</sub>. 以下伪代码展示了<code>DelegatingFilterProxy</code>的使用:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Lazily get Filter that was registered as a Spring Bean</span>
    <span class="token comment">// For the example in DelegatingFilterProxy delegate is an instance of Bean Filter0</span>
    <span class="token class-name">Filter</span> delegate <span class="token operator">=</span> <span class="token function">getFilterBean</span><span class="token punctuation">(</span>someBeanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// delegate work to the Spring Bean</span>
    delegate<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用<code>DelegatingFilterProxy</code>的另一个好处是允许<code>Filter</code>Bean的延迟查找. 这一点十分重要, 因为容器需要在启动之前对<code>Filter</code>实例j进行注册. 然而Spring通常在<code>Filter</code>实例注册完成后才会使用<code>ContextLoaderListener</code>完成Spring Bean加载.</p>
<h2 id="FilterChainProxy"><a href="#FilterChainProxy" class="headerlink" title="FilterChainProxy"></a><strong>FilterChainProxy</strong></h2><p>Spring Security的Servlet支持包含于<code>FilterChainProxy</code>. <code>FilterChainProxy</code>是Spring Security提供的一个特殊的<code>Filter</code>, 允许通过SecurityFilterChain委托给许多<code>Filter</code>实例. 因为<code>FilterChainProxy</code>是一个Bean, 所以通常使用<code>DelegatingFilterProxy</code>装饰.<br><img src="https://cdn.jsdelivr.net/gh/in-a-day/cdn@main/images/java/spring/spring-security/filterchainproxy.png" alt="FilterChainProxy" loading="lazy"><em>FilterChainProxy</em></p>
<h2 id="SecurityFilterChain"><a href="#SecurityFilterChain" class="headerlink" title="SecurityFilterChain"></a><strong>SecurityFilterChain</strong></h2><p><code>SecurityFilterChain</code>用于<code>FilterChainProxy</code>决定哪些Spring Security的<code>Filter</code>需要在此次请求中调用.</p>
<p><img src="https://cdn.jsdelivr.net/gh/in-a-day/cdn@main/images/java/spring/spring-security/securityfilterchain.png" alt="SecurityFilterChain" loading="lazy"><em>SecurityFilterChain</em></p>
<p><code>SecurityFilterChain</code>中的<code>Security Filters</code>通常都是Bean, 但是他们由<code>FilterChainProxy</code>注册而不是<code>DelegatingFilterChain</code>. 相比于通过<code>DelegatingFilterProxy</code>或者Servlet容器注册来说, 使用<code>FilterChainProxy</code>提供了大量的好处:</p>
<ul>
<li>首先, 它为Spring Security的Servlet支持提供了一个开始点. 因此, 如果你想要去排除Spring Security的容器支持故障, 就可以在<code>FilterChainProxy</code>中打断点.</li>
<li>第二, 因为<code>FilterChainProxy</code>是Spring Security执行的核心, 所以它可以执行被视为不可选的任务(即该任务必须执行?). 例如, 它清除<code>SecurityContext</code>避免内存泄漏. 它也应用Spring Security的<code>HttpFirewall</code>保护应用免遭特定类型的攻击.</li>
<li>此外, 它提供了更为灵活的方式决定一个<code>SecurityFilterChain</code>是否应该被调用. 在Servlet容器中, <code>Fitler</code>是基于URL调用的. 然而<code>FilterChainProxy</code>可以通过利用<code>RequestMathcer</code>接口, 基于<code>HttpServletRequest</code>中任何信息决定调用.</li>
</ul>
<p>实际上, <code>FilterChainProxy</code>可以用于决定执行哪一个<code>SecurityFilterChain</code>.<br><img src="https://cdn.jsdelivr.net/gh/in-a-day/cdn@main/images/java/spring/spring-security/multi-securityfilterchain.png" alt="Multiple SecurityFilterChain" loading="lazy"><em>Multiple SecurityFilterChain</em><br>上图中, <code>FilterChainProxy</code>决定了哪一个<code>SecurityFilterChain</code>该被使用. 只有第一个匹配的<code>SecurityFilterChain</code>才会被调用. 如果请求<code>/api/messages</code>URL, 那么SecurityFilterChain<sub>0</sub>将会匹配(由于其模式是<code>/api/**</code>), 所以只有SecurityFilterChain<sub>0</sub>会被调用. 如果请求的URL是<code>/message/</code>, 那么SecurityFilterChain<sub>0</sub>不会匹配, 所以<code>FilterChainProxy</code>会继续尝试调用每个<code>SecurityFilterChain</code>. 如果没有其他的<code>SecurityFilterChain</code>匹配, 最后匹配的SecurityFilterChain<sub>n</sub>将会被调用.</p>
<p><strong>NB:每个<code>SecurityFilterChain</code>都可以是唯一的, 并且可以单配置.</strong> 事实上, 一个<code>SecurityFilterChain</code>可能有0个security <code>Filter</code>(如果应用希望Spring Security忽略特定的请求).</p>
<h2 id="Security-Filters"><a href="#Security-Filters" class="headerlink" title="Security Filters"></a><strong>Security Filters</strong></h2><p>Security Filters通过SecurityFilterChain API插入FilterChainProxy. Filters的顺序十分重要. 通常没有必要去了解Spring Security Filters的顺序. 然而有时候还是有必要去知道这些顺序的. 以下是完成的Spring Security Filter 排序:</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">ChannelProcessingFilter

WebAsyncManagerIntegrationFilter

SecurityContextPersistenceFilter

HeaderWriterFilter

CorsFilter

CsrfFilter

LogoutFilter

OAuth2AuthorizationRequestRedirectFilter

Saml2WebSsoAuthenticationRequestFilter

X509AuthenticationFilter

AbstractPreAuthenticatedProcessingFilter

CasAuthenticationFilter

OAuth2LoginAuthenticationFilter

Saml2WebSsoAuthenticationFilter

UsernamePasswordAuthenticationFilter

OpenIDAuthenticationFilter

DefaultLoginPageGeneratingFilter

DefaultLogoutPageGeneratingFilter

ConcurrentSessionFilter

DigestAuthenticationFilter

BearerTokenAuthenticationFilter

BasicAuthenticationFilter

RequestCacheAwareFilter

SecurityContextHolderAwareRequestFilter

JaasApiIntegrationFilter

RememberMeAuthenticationFilter

AnonymousAuthenticationFilter

OAuth2AuthorizationCodeGrantFilter

SessionManagementFilter

ExceptionTranslationFilter

FilterSecurityInterceptor

SwitchUserFilter<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="处理Security异常"><a href="#处理Security异常" class="headerlink" title="处理Security异常"></a><strong>处理Security异常</strong></h2><p><code>ExceptionTranslationFilter</code>允许将<code>AccessDeniedException</code>和<code>AuthenticalException</code>转换为Http 响应. <code>ExceptionTranslationFilter</code>作为<code>SecurityFilters</code>之一被插入到<code>FilterChainProxy</code>中.</p>
<p><img src="https://cdn.jsdelivr.net/gh/in-a-day/cdn@main/images/java/spring/spring-security/exceptiontranslationfilter.png" alt="ExceptionTranslationFilter" loading="lazy"><em>ExceptionTranslationFilter</em></p>
<ul>
<li>首先, <code>ExceptionTranslationFilter</code>调用<code>FilterChain.doFilter(request, response)</code>去调用应用的剩余部分.</li>
<li>如果用户未认证或抛出AuthenticationException异常, 开始进行认证:<ul>
<li>清空<code>SecurityContextHolder</code></li>
<li>将<code>HttpServletRequest</code>保存到<code>RequestCache</code>中. 当用户成功认证后, 将<code>RequestCache</code>内容重播原始request.</li>
<li><code>AuthenticationEntryPoint</code>用于从客户端请求凭证(credential). 例如, 它可能重定向到登录页面或者发送一个<code>WWW-Authenticat</code>头部(header).</li>
</ul>
</li>
<li>否则, 如果产生<code>AccessDeniedException</code>, 那么拒绝访问. 调用<code>AccessHandler</code>处理决绝访问.</li>
</ul>
<p><strong>NB: 如果应用不抛出<code>AccessDeniedException</code>或<code>AuthenticationException</code>异常, 那么<code>ExceptionTranslationFilter</code>什么都不会做.</strong> </p>
<p>上述<code>ExceptionTranslationFilter</code>伪代码如下:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 1</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AccessDeniedException</span> <span class="token operator">|</span> <span class="token class-name">AuthenticationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>authentication <span class="token operator">||</span> ex <span class="token keyword">instanceof</span> <span class="token class-name">AuthenticationException</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">startAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 2</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token function">accessDenied</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 3</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1: 意味着如果应用的其他部分抛出了<code>AccessDeniedException</code>或<code>AuthenticationException</code>异常, 将在此处捕获</li>
<li>2: 如果用户尚未认证, 或者抛出的是AuthenticationException, 那么开始认证.</li>
<li>3: 其他情况, 拒绝访问.</li>
</ul>
</div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>z</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="http://nichijou.cloud/2021/03/24/spring/spring-security/spring_security_with_servlet/" title="Spring Security Filter使用(5.4.5)">http://nichijou.cloud/2021/03/24/spring/spring-security/spring_security_with_servlet/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><svg class="icon"><use xlink:href="#icon-creative-commons-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-by-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-nc-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-sa-line"></use></svg></a> 许可协议。</li></ul></section></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/2021/03/24/spring/spring-security/spring_security_authentication/" rel="prev" title="Spring Security Authentication(认证)(5.4.5)"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-left-s-line"></use></svg><span class="post-nav-text">Spring Security Authentication(认证)(5.4.5)</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/2021/03/24/spring/spring-security/spring_security_module/" rel="next" title="Spring Security模块介绍(5.4.5)"><span class="post-nav-text">Spring Security模块介绍(5.4.5)</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-right-s-line"></use></svg></a></div></div></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2021 </span><span class="with-love" id="animate"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></span><span class="author"> z</span></div><div class="powered"><span>由 <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> 驱动 v5.4.0</span><span class="footer-separator">|</span><span>主题 - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.4.0</span></div></footer><a class="hty-icon-button" id="goUp" aria-label="back-to-top" href="#"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-up-s-line"></use></svg><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a><a class="popup-trigger hty-icon-button icon-search" id="search" href="javascript:;" title="搜索"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search-line"></use></svg></span></a><script>window.addEventListener("DOMContentLoaded", () => {
  // Handle and trigger popup window
  document.querySelector(".popup-trigger").addEventListener("click", () => {
    document.querySelector(".popup").classList.add("show");
    setTimeout(() => {
      document.querySelector(".search-input").focus();
    }, 100);
  });

  // Monitor main search box
  const onPopupClose = () => {
    document.querySelector(".popup").classList.remove("show");
  };

  document.querySelector(".popup-btn-close").addEventListener("click", () => {
    onPopupClose();
  });

  window.addEventListener("keyup", event => {
    if (event.key === "Escape") {
      onPopupClose();
    }
  });
});
</script><script src="/js/search/local-search.js" defer></script><div class="popup search-popup"><div class="search-header"><span class="popup-btn-close close-icon hty-icon-button"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-close-line"></use></svg></span></div><div class="search-input-container"><input class="search-input" id="local-search-input" type="text" placeholder="搜索..." value=""></div><div id="local-search-result"></div></div></div></body></html>